<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>平屋慢生活 - Coding也是生活的溫暖調味</title><meta name="author" content="Allen"><meta name="copyright" content="Allen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="平屋慢生活">
<meta property="og:url" content="https://allenlin000.github.io.git/page/4/">
<meta property="og:site_name" content="平屋慢生活">
<meta property="og:locale">
<meta property="og:image" content="https://i.imgur.com/q4xr50n.png">
<meta property="article:author" content="Allen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/q4xr50n.png"><link rel="shortcut icon" href="/img/kiwibird.png"><link rel="canonical" href="https://allenlin000.github.io.git/page/4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '平屋慢生活',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2026-01-05 08:21:35'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.imgur.com/q4xr50n.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">217</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">25</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header" style="background-image: url('https://i.imgur.com/86eENHu.png')"><nav id="nav"><span id="blog-info"><a href="/" title="平屋慢生活"><span class="site-name">平屋慢生活</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">平屋慢生活</h1><div id="site_social_icons"><a class="social-icon" href="https://github.com/CHI-KEKE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chilly37647@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/10/Test-%E7%86%94%E6%96%B7/" title="Circuit Breaker"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/System-Design/security.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Circuit Breaker"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/10/Test-%E7%86%94%E6%96%B7/" title="Circuit Breaker">Circuit Breaker</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-10T04:10:11.000Z" title="Created 2025-11-10 12:10:11">2025-11-10</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%9E%B6%E6%A7%8B%E3%81%AE%E6%B5%B7%E3%81%AB%E7%81%AF%E3%82%8B%E6%98%9F/">架構の海に灯る星</a></span></div><div class="content">
熔斷並不是「修補不穩定」的設計，而是預防連鎖崩潰的一種保險。就像電路裡的保險絲，當某個服務過載或回應過慢時，熔斷器會暫時中斷請求，防止所有流量一起壓垮整個系統。這其實是一種「系統彈性」設計哲學
熔斷後要多久恢復？如果恢復太慢會影響體驗，太快又可能反覆熔斷？這是一種「穩定 vs 敏捷」的矛盾。恢復時間太短，會導致「抖動效應」——服務剛好起來又被壓垮；太長則使用者體驗差。理想的策略是設一個半開狀態（Half-Open）：部分流量試探性放行
假設支付服務在 10 秒內失敗了 5 次後被熔斷。30 秒後熔斷器自動進入「半開」，只允許 10% 的請求通過測試；若成功率高於 80%，則恢復正常運行
熔斷與重試（Retry）會不會互相衝突「重試」希望挽救暫時錯誤，「熔斷」希望阻止持續錯誤，若兩者交錯使用不當，會導致雪崩效應（大量重試瞬間壓垮服務）
在支付請求中若每次失敗都重試3次，而熔斷器設定在10次錯誤觸發，實際上只要4個使用者同時錯誤，就可能觸發熔斷。
</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/10/Test-%E7%B5%90%E5%B8%B3%E7%B3%BB%E7%B5%B1/" title="結帳系統"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/System-Design/security.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="結帳系統"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/10/Test-%E7%B5%90%E5%B8%B3%E7%B3%BB%E7%B5%B1/" title="結帳系統">結帳系統</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-10T04:10:11.000Z" title="Created 2025-11-10 12:10:11">2025-11-10</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%9E%B6%E6%A7%8B%E3%81%AE%E6%B5%B7%E3%81%AB%E7%81%AF%E3%82%8B%E6%98%9F/">架構の海に灯る星</a></span></div><div class="content">
加入購物車限流器單位時間內，限制可以加入購物車的數量
兩層票匣（Token Bucket）+ 秒級時間窗可以把每個方塊視為「某個時間窗內允許的票（tokens）」：

By SkuId 的票匣：每個 SKU 每秒最多 100 次加入（圖的 100 只是示意）。同一秒內，第 101 個想加的，因為他拿不到票，就被「請稍後再試」。

By ShopId 的票匣：同一商店合計每秒最多 1000 次加入。即使很多 SKU 分散加，也不能超過商店總上限，避免把該商店的後端資源用光。

時間軸（1s、2s、3s、…、ns）：代表「固定秒級視窗」或「每秒補票」。每過一秒，票匣重新裝滿（或按速率補票），下一秒再算。


🌳 「要通過，得同時有 Sku 的票 + Shop 的票」。任一票用完就被擋
〈每家店獨立設定〉—配額可調、資源隔離Shop A、Shop B 各自一套配額

A 店的白&#x2F;藍&#x2F;黃（SKU）可以是每秒 100。
B 店的大小中 SKU 也各有每秒 100。

營運面可調。大店、熱門品給高一點；新店、長尾品給保守值。
把限流放在「加入購物車」前段，Fail-fast ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/10/Test-%E9%99%90%E6%B5%81%E5%99%A8/" title="Rate Limiter"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/System-Design/security.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Rate Limiter"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/10/Test-%E9%99%90%E6%B5%81%E5%99%A8/" title="Rate Limiter">Rate Limiter</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-10T04:10:11.000Z" title="Created 2025-11-10 12:10:11">2025-11-10</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%9E%B6%E6%A7%8B%E3%81%AE%E6%B5%B7%E3%81%AB%E7%81%AF%E3%82%8B%E6%98%9F/">架構の海に灯る星</a></span></div><div class="content">
限流設定太嚴活動秒殺時，限流設定太嚴導致一堆使用者被攔在外，但系統明明負載還有餘裕
限流規則以「API層」為單位，還是以「使用者動作意圖」為單位深層解析
多數限流設計只看 API 請求頻率（例如每秒可呼叫幾次），但購物行為其實是「任務導向」的。同樣的 API，在不同情境下（加購、改數量、結帳前檢查）代表不同優先度。若只看技術層頻率，會錯殺真實用戶。這是「技術限流」與「業務語意限流」的衝突。
具體例子
A 用戶在秒殺活動中加購一件商品，B 用戶在修改購物車，兩者都觸發相同限流規則，但其實 A 的行為應該更被優先處理。
限流的錯誤回饋，是「資訊透明」還是「行為引導」目前許多限流回饋只是彈窗：「因搶購熱烈，請稍後再試」。但這會導致用戶亂重試、加重流量。若能在訊息中加入「重試建議」或「倒數回應」，就能把限流轉化為節流（引導行為）。這是「被動防守」與「主動引導」的矛盾。
具體例子
使用者被告知「請稍後重試」不如告訴他「系統將於3秒後自動重試」或「已為你保留名額30秒」。
限流策略是否考慮跨服務依賴（例如庫存、票匣、購物車）之間的同步深層解析
目前流程是線性檢查（庫存 → 全店票匣 → SKU票 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/08/DeepType-CPU-CPU-DB/" title="CPU - DB"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/Server/cat.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CPU - DB"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/08/DeepType-CPU-CPU-DB/" title="CPU - DB">CPU - DB</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-08T15:00:00.000Z" title="Created 2025-11-08 23:00:00">2025-11-08</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Server/">Server</a></span></div><div class="content">NodeRW / ROCPU 效能消耗來源CPU HIGH 原因分析檢查 Query Plain 方式搶券優化 - 關於 tempTable 濫用後台付款查詢 - 關於索引一個 Node &#x3D; 一個獨立運作的資料庫執行單位，實務上 通常對應一台 Instance（VM &#x2F; EC2 &#x2F; RDS instance）
一個「節點」就是一台資料庫伺服器（Server），在分散式或高可用架構中會有多台，也就是多節點佈署
1234567891011121314  +-------------------------+  |     App / API Server    |  +-----------+-------------+              |              v┌─────────────────────────────┐│         DB Cluster          │├─────────────────────────────┤│ RW Node (Primary)           │  ← 負責寫入、交易、更新│     ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/06/DeepType-DDB-DynamoDB-%E8%AE%93%E6%B5%81%E9%87%8F%E8%B5%B0%E6%95%A3%EF%BC%8C%E6%98%AF%E6%9C%80%E6%BA%AB%E6%9F%94%E7%9A%84%E9%98%B2%E7%A6%A6/" title="DynamoDB - 讓流量走散，是最溫柔的防禦"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/noSQL/tags.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DynamoDB - 讓流量走散，是最溫柔的防禦"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/06/DeepType-DDB-DynamoDB-%E8%AE%93%E6%B5%81%E9%87%8F%E8%B5%B0%E6%95%A3%EF%BC%8C%E6%98%AF%E6%9C%80%E6%BA%AB%E6%9F%94%E7%9A%84%E9%98%B2%E7%A6%A6/" title="DynamoDB - 讓流量走散，是最溫柔的防禦">DynamoDB - 讓流量走散，是最溫柔的防禦</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-06T09:54:05.000Z" title="Created 2025-11-06 17:54:05">2025-11-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/noSQL/">noSQL</a></span></div><div class="content">DynamoDB 是怎麼把「高併發壓力」攤平的DynamoDB 是怎麼把「高併發壓力」攤平的流量真的變很大時，DynamoDB 會做什麼購物車回饋活動管庫存資料存取模式明確、可預期的系統「不適合」用 DynamoDB
不要硬撐，不要集中，讓壓力自然就是分流，是最溫柔也最有效的防禦
如果把所有時間自我認同都投入單一面向上，一旦單點開始延遲、停滯、壓力襲來，整個人不是失落而是直接瓦解，開始焦慮、開始失去存在感
把自己拆成很多 partition，工作只是其中一塊、關係只是其中一塊，興趣、休息、身體、學習，各自扛一點
某一塊出問題 ≠ 整個人生當機
人生若綁定特定的 hot key ，可能是只從某個人那裡獲得肯定、只用成績證明自己、只靠收入撐安全感、情緒只剩一個出口，那個地方一爆，你會覺得為什麼我明明很努力，卻撐不住？不是你不夠強，而是你把所有流量都導到同一個點
我不需要承受，只要分散DynamoDB 一開始就把資料切碎，讓很多台機器各自扛一小部分，DynamoDB 真正在做的是資料本來就分散在很多 partition，當流量來了會調整 partition 數量與吞吐，這會讓「請求平均打到不 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/06/DeepType-DDB-DynamoDB-%E5%9F%BA%E7%A4%8E%E6%A6%82%E5%BF%B5-%E5%88%86%E6%95%A3%E7%9A%84%E8%97%9D%E8%A1%93/" title="DynamoDB 基礎概念 - 分散的藝術"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/noSQL/tags.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DynamoDB 基礎概念 - 分散的藝術"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/06/DeepType-DDB-DynamoDB-%E5%9F%BA%E7%A4%8E%E6%A6%82%E5%BF%B5-%E5%88%86%E6%95%A3%E7%9A%84%E8%97%9D%E8%A1%93/" title="DynamoDB 基礎概念 - 分散的藝術">DynamoDB 基礎概念 - 分散的藝術</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-06T09:54:05.000Z" title="Created 2025-11-06 17:54:05">2025-11-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/noSQL/">noSQL</a></span></div><div class="content">故事：圖書館的智慧📘 RCU & WCU：圖書館的服務能量☁️ Serverless：你不用管伺服器🚦 Throttling：被限流了怎麼辦🔑 Partition Key：資料的身分證
想像一座巨大的圖書館，每天有成千上萬的人來借還書。
傳統的圖書館只有一個櫃檯，所有人都要排隊等候同一個館員處理。高峰時段，隊伍排得很長，有人只是想借一本輕小說，卻要等前面的人處理完十幾本厚重的專業書籍。
聰明的館長決定改革：

把圖書館分成多個區域（Partition）：小說區、科技區、藝術區…每個區都有獨立的櫃檯
每本書都有明確的歸屬（Partition Key）：根據書的類別編號，自動知道該去哪個櫃檯
每個櫃檯都能獨立工作（分散式處理）：不會因為科技區很忙，就影響到小說區的借書速度

這就是 DynamoDB 的核心思想：不要讓所有人擠在同一個地方，把壓力分散開來，每個人都能快速得到服務。
當某個區域（partition）突然湧入大量讀者，館長不需要叫所有館員都跑去幫忙，只要在那個區域增加一個臨時櫃檯就好。這就是 Serverless 和 Auto Scaling 的概念。
但如果所有人都只想 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/06/Middleware-Middleware/" title="Middleware"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/WebAPI/tree.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Middleware"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/06/Middleware-Middleware/" title="Middleware">Middleware</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-06T06:07:05.000Z" title="Created 2025-11-06 14:07:05">2025-11-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/WebAPI/">WebAPI</a></span></div><div class="content">
🎃 Middleware 的運作原理ASP.NET Core 的請求流程是一條「洋蔥模型」
Request → [Middleware1] → [Middleware2] → [Middleware3] → Controller                                       ← Response ←
每一層 Middleware 都是依照 註冊順序 被包起來的，當 UseMiddleware() 被呼叫時，ASP.NET Core 會建立一個委派 (RequestDelegate)，將後面的 Middleware 當作「下一層」傳入，執行邏輯後決定是否呼叫 await next(context)



🎃 如何「交換 Middleware 的順序」

✅ 方法一：直接調整註冊順序在 Program.cs 或 Startup.cs 的 Configure() 方法中，Middleware 是 照順序被執行 的
123app.UseMiddleware&lt;A&gt;();app.UseMiddleware&lt;B&gt;();app.UseMidd ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/06/webapi-middlewareeee/" title="Middleware"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Middleware"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/06/webapi-middlewareeee/" title="Middleware">Middleware</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-06T06:07:05.000Z" title="Created 2025-11-06 14:07:05">2025-11-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/WebAPI/">WebAPI</a></span></div><div class="content">🎃 Middleware 的運作原理ASP.NET Core 的請求流程是一條「洋蔥模型」
Request → [Middleware1] → [Middleware2] → [Middleware3] → Controller                                       ← Response ←
每一層 Middleware 都是依照 註冊順序 被包起來的，當 UseMiddleware() 被呼叫時，ASP.NET Core 會建立一個委派 (RequestDelegate)，將後面的 Middleware 當作「下一層」傳入，執行邏輯後決定是否呼叫 await next(context)



🎃 如何「交換 Middleware 的順序」

✅ 方法一：直接調整註冊順序在 Program.cs 或 Startup.cs 的 Configure() 方法中，Middleware 是 照順序被執行 的
123app.UseMiddleware&lt;A&gt;();app.UseMiddleware&lt;B&gt;();app.UseMiddl ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/06/DI-Dependency-Injection-Stateless-Stateful/" title="Dependency Injection - Stateless / Stateful"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection - Stateless / Stateful"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/06/DI-Dependency-Injection-Stateless-Stateful/" title="Dependency Injection - Stateless / Stateful">Dependency Injection - Stateless / Stateful</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-06T02:43:05.000Z" title="Created 2025-11-06 10:43:05">2025-11-06</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A3%AE/">注入之森</a></span></div><div class="content">🪵 先回顧三種生命週期 (Lifetime)在 .NET DI 裡，我們註冊服務時通常會用三種生命週期



生命週期
建立時機
何時被回收
常見用途



Transient
每次注入時都會 new 一個新的實例
呼叫結束後可回收
短期任務、帶狀態的物件


Scoped
每個 Request (或每個範圍) 共用同一個實例
Request 結束時回收
Web Request、單次工作


Singleton
程式啟動時建立一次，全程共用
應用程式結束時回收
共用服務、無狀態服務


判斷要用哪一種：看「是否有狀態」



狀態性質
適合的 Lifetime
原因



有狀態 (Stateful)
Transient &#x2F; Scoped
需要獨立實例以避免狀態被共用


無狀態 (Stateless)
Singleton
可以安全共用，不會互相影響





🪵 為什麼「無狀態」通常用 Singleton？
無狀態類別不會保存任何資料
多執行緒 (multi-thread) 呼叫時不會互相干擾
所以可以讓整個應用程式共用同一個實例
可以減少 new 實例的開銷，提高效能 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/11/03/DeepType-ThinkingMind-%E9%80%B1%E6%9C%9F%E6%80%A7%E8%A7%B8%E7%99%BC/" title="Modulo — 記憶の螺旋"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/%E6%80%9D%E7%B4%A2%E6%97%A5%E5%92%8C/Stamp.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Modulo — 記憶の螺旋"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/11/03/DeepType-ThinkingMind-%E9%80%B1%E6%9C%9F%E6%80%A7%E8%A7%B8%E7%99%BC/" title="Modulo — 記憶の螺旋">Modulo — 記憶の螺旋</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-11-03T00:32:03.000Z" title="Created 2025-11-03 08:32:03">2025-11-03</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%80%9D%E7%B4%A2%E6%97%A5%E5%92%8C/">思索日和</a></span></div><div class="content">
我們的人生，其實一直在「取餘數」。  情緒、記憶、學習、努力都不會線性遞增，而是像 % 一樣，在週期中反覆歸零、再度啟程。
有時你覺得自己白學了、白走了，那不代表歸零，而是走到了週期的端點。  正如程式中的 (value % max) + 1，每一次「重來」，其實都讓下一次更穩、更深、更有方向
時間並非直線，而是一個緩慢旋轉的螺旋。我們以為在重複，其實在上升。  我們以為忘記，其實在沉澱
modulo operation，代表著一個循環的時間軸



場景
用法
解釋



日誌
if (i % 100 == 0)
每 100 筆印一次進度


遊戲
if (frameCount % 60 == 0)
每秒（60 幀）更新一次畫面


備份
if (dayCount % 7 == 0)
每 7 天備份一次資料


批次任務
if (index % batchSize == 0)
每批結束時觸發事件




🕊️ spiral learning9 天內學會 3 個日文詞彙，每天會複習一次，每三天會加強記憶深度
我們需要把 週期 (%) 的節奏，結合 遞進的權重
12345678910 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/3/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/#content-inner">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/#content-inner">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/#content-inner">22</a><a class="extend next" rel="next" href="/page/5/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.imgur.com/q4xr50n.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Allen</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">217</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">25</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/CHI-KEKE"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CHI-KEKE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chilly37647@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">世界上總會有一些溫暖的小角落</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/04/DeepType-K8S-Docker-file/" title="Dockerfile"><img src="https://raw.githubusercontent.com/CHI-KEKE/pics/refs/heads/main/Random/Whale.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dockerfile"/></a><div class="content"><a class="title" href="/2026/01/04/DeepType-K8S-Docker-file/" title="Dockerfile">Dockerfile</a><time datetime="2026-01-04T06:09:05.000Z" title="Created 2026-01-04 14:09:05">2026-01-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/03/DeepType-K8S-Image-Layer/" title="Image Layer"><img src="https://raw.githubusercontent.com/CHI-KEKE/pics/refs/heads/main/Random/Whale.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Image Layer"/></a><div class="content"><a class="title" href="/2026/01/03/DeepType-K8S-Image-Layer/" title="Image Layer">Image Layer</a><time datetime="2026-01-03T02:31:05.000Z" title="Created 2026-01-03 10:31:05">2026-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/02/DeepType-ThinkingMind-%E6%9C%9F%E6%9C%9B%E5%80%BC/" title="Expected Value"><img src="https://github.com/CHI-KEKE/pics/blob/main/%E6%80%9D%E7%B4%A2%E6%97%A5%E5%92%8C/Stamp.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Expected Value"/></a><div class="content"><a class="title" href="/2026/01/02/DeepType-ThinkingMind-%E6%9C%9F%E6%9C%9B%E5%80%BC/" title="Expected Value">Expected Value</a><time datetime="2026-01-02T13:37:03.000Z" title="Created 2026-01-02 21:37:03">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/02/DeepType-ThinkingMind-Bulls-and-Cows/" title="Untitled"><img src="https://i.imgur.com/f2eWUWv.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Untitled"/></a><div class="content"><a class="title" href="/2026/01/02/DeepType-ThinkingMind-Bulls-and-Cows/" title="Untitled">Untitled</a><time datetime="2026-01-02T00:51:45.615Z" title="Created 2026-01-02 08:51:45">2026-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/25/DeepType-K8S-container/" title="Container"><img src="https://raw.githubusercontent.com/CHI-KEKE/pics/refs/heads/main/Random/Whale.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Container"/></a><div class="content"><a class="title" href="/2025/12/25/DeepType-K8S-container/" title="Container">Container</a><time datetime="2025-12-25T09:54:05.000Z" title="Created 2025-12-25 17:54:05">2025-12-25</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>Categories</span>
            <a class="card-more-btn" href="/categories/" title="View More">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/C/"><span class="card-category-list-name">C#</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Config/"><span class="card-category-list-name">Config</span><span class="card-category-list-count">5</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Docker/"><span class="card-category-list-name">Docker</span><span class="card-category-list-count">3</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/LINQ/"><span class="card-category-list-name">LINQ</span><span class="card-category-list-count">12</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/MVC/"><span class="card-category-list-name">MVC</span><span class="card-category-list-count">4</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Others/"><span class="card-category-list-name">Others</span><span class="card-category-list-count">14</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/SQL-%E8%81%B7%E5%A0%B4%E6%AD%B7%E9%9A%AA%E8%A8%98/"><span class="card-category-list-name">SQL 職場歷險記</span><span class="card-category-list-count">11</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Server/"><span class="card-category-list-name">Server</span><span class="card-category-list-count">1</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>Tags</span></div><div class="card-tag-cloud"><a href="/tags/WebAPI/" style="font-size: 1.1em; color: #999">WebAPI -</a> <a href="/tags/MVC/" style="font-size: 1.22em; color: #999ea4">MVC</a> <a href="/tags/AWS/" style="font-size: 1.1em; color: #999">AWS</a> <a href="/tags/Plugin-Pattern%EF%BC%88%E5%A4%96%E6%8E%9B%E6%A8%A1%E5%BC%8F%EF%BC%89x-Factory-Method-Pattern%EF%BC%88%E5%B7%A5%E5%BB%A0%E6%96%B9%E6%B3%95%EF%BC%89x-Strategy-Pattern%EF%BC%88%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%EF%BC%89/" style="font-size: 1.1em; color: #999">Plugin Pattern（外掛模式）x Factory Method Pattern（工廠方法）x Strategy Pattern（策略模式）</a> <a href="/tags/WebAPI/" style="font-size: 1.42em; color: #99a6b7">WebAPI</a> <a href="/tags/Memory/" style="font-size: 1.1em; color: #999">Memory</a> <a href="/tags/EF-CORE/" style="font-size: 1.5em; color: #99a9bf">EF CORE</a> <a href="/tags/Enum/" style="font-size: 1.18em; color: #999ca1">Enum</a> <a href="/tags/JSON/" style="font-size: 1.1em; color: #999">JSON</a> <a href="/tags/Config/" style="font-size: 1.18em; color: #999ca1">Config</a> <a href="/tags/Delegate/" style="font-size: 1.18em; color: #999ca1">Delegate</a> <a href="/tags/Cache/" style="font-size: 1.22em; color: #999ea4">Cache</a> <a href="/tags/Server/" style="font-size: 1.1em; color: #999">Server</a> <a href="/tags/LINQ/" style="font-size: 1.42em; color: #99a6b7">LINQ</a> <a href="/tags/System-Text-Json/" style="font-size: 1.1em; color: #999">System.Text.Json</a> <a href="/tags/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/" style="font-size: 1.26em; color: #999fa8">資料疆界的航圖</a> <a href="/tags/%E9%A2%A8%E9%9F%B3%E5%AD%90/" style="font-size: 1.1em; color: #999">風音子</a> <a href="/tags/Docker/" style="font-size: 1.18em; color: #999ca1">Docker</a> <a href="/tags/SOLID/" style="font-size: 1.1em; color: #999">SOLID</a> <a href="/tags/%E6%83%85%E5%A0%B1%E3%81%AE%E5%AD%98%E5%9C%A8%E8%AB%96/" style="font-size: 1.38em; color: #99a4b4">情報の存在論</a> <a href="/tags/C/" style="font-size: 1.3em; color: #99a1ac">C#</a> <a href="/tags/Design/" style="font-size: 1.26em; color: #999fa8">Design</a> <a href="/tags/%E6%9E%B6%E6%A7%8B%E3%81%AE%E6%B5%B7%E3%81%AB%E7%81%AF%E3%82%8B%E6%98%9F/" style="font-size: 1.22em; color: #999ea4">架構の海に灯る星</a> <a href="/tags/SQL-%E8%81%B7%E5%A0%B4%E6%AD%B7%E9%9A%AA%E8%A8%98/" style="font-size: 1.22em; color: #999ea4">SQL 職場歷險記</a> <a href="/tags/Delegate-x-Observer-Pattern/" style="font-size: 1.1em; color: #999">Delegate x Observer Pattern</a> <a href="/tags/Tools/" style="font-size: 1.14em; color: #999b9d">Tools</a> <a href="/tags/Code/" style="font-size: 1.1em; color: #999">Code</a> <a href="/tags/%E6%9E%B6%E6%A7%8B%E3%81%AE%E6%B5%B7%E3%81%AB%E7%81%AF%E3%82%8B%E6%98%9F%E3%84%8B/" style="font-size: 1.1em; color: #999">架構の海に灯る星ㄋ</a> <a href="/tags/noSQL/" style="font-size: 1.14em; color: #999b9d">noSQL</a> <a href="/tags/ThirdParty/" style="font-size: 1.1em; color: #999">ThirdParty</a> <a href="/tags/%E6%80%9D%E7%B4%A2%E6%97%A5%E5%92%8C/" style="font-size: 1.26em; color: #999fa8">思索日和</a> <a href="/tags/Serialization/" style="font-size: 1.1em; color: #999">Serialization</a> <a href="/tags/Dependency-Injection/" style="font-size: 1.18em; color: #999ca1">Dependency Injection</a> <a href="/tags/Http/" style="font-size: 1.3em; color: #99a1ac">Http</a> <a href="/tags/Encode/" style="font-size: 1.22em; color: #999ea4">Encode</a> <a href="/tags/Validation/" style="font-size: 1.1em; color: #999">Validation</a> <a href="/tags/%E7%A8%8B%E6%80%9D%E8%88%9E%E6%83%B3/" style="font-size: 1.22em; color: #999ea4">程思舞想</a> <a href="/tags/Asynchronous-Programming/" style="font-size: 1.46em; color: #99a7bb">Asynchronous Programming</a> <a href="/tags/Newtonsoft-Json/" style="font-size: 1.1em; color: #999">Newtonsoft.Json</a> <a href="/tags/%E8%92%BC%E3%81%8D%E7%9B%BE/" style="font-size: 1.34em; color: #99a3b0">蒼き盾</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>Archives</span><a class="card-more-btn" href="/archives/" title="View More">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">January 2026</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">December 2025</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/11/"><span class="card-archive-list-date">November 2025</span><span class="card-archive-list-count">35</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">October 2025</span><span class="card-archive-list-count">37</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">September 2025</span><span class="card-archive-list-count">33</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">August 2025</span><span class="card-archive-list-count">17</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">July 2025</span><span class="card-archive-list-count">9</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">June 2025</span><span class="card-archive-list-count">2</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>Info</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">Article :</div><div class="item-count">217</div></div><div class="webinfo-item"><div class="item-name">Runtime :</div><div class="item-count" id="runtimeshow" data-publishDate="2024-03-01T10:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">UV :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">PV :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">Last Update :</div><div class="item-count" id="last-push-date" data-lastPushDate="2026-01-05T00:21:35.355Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.imgur.com/yZlXwed.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2026 By Allen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">What you'll find out there is boundless freedom !</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>